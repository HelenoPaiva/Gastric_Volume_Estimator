<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gastric Volume Calculator</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MathJax for LaTeX -->
  <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-svg.js" async></script>

  <!-- Meta for SEO -->
  <meta name="description" content="Estimate gastric volume and aspiration risk using Perlas’s formula." />
  <meta name="author" content="Your Name or Institution" />

  <!-- Optional favicon -->
  <link rel="icon" href="/favicon.ico" type="image/x-icon" />
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center px-4">
  <div class="container mx-auto max-w-xl bg-white p-8 rounded-xl shadow-lg border border-gray-200">
    <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">Gastric Volume Calculator</h1>
    <p class="text-gray-600 text-center mb-6">
      Enter the patient's data below to estimate gastric volume and aspiration risk based on Perlas's formula.
    </p>

    <!-- Form -->
    <form id="gastric-form" class="space-y-4" novalidate>
      <div>
        <label for="ap-diameter" class="block text-sm font-medium text-gray-700 mb-1">Anteroposterior (AP) Diameter (cm)</label>
        <input type="number" id="ap-diameter" name="ap-diameter" step="0.1" required autofocus
               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" />
      </div>

      <div>
        <label for="cc-diameter" class="block text-sm font-medium text-gray-700 mb-1">Craniocaudal (CC) Diameter (cm)</label>
        <input type="number" id="cc-diameter" name="cc-diameter" step="0.1" required
               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" />
      </div>

      <div>
        <label for="age" class="block text-sm font-medium text-gray-700 mb-1">Age (years)</label>
        <input type="number" id="age" name="age" step="0.1" required
               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" />
      </div>

      <div>
        <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">Weight (kg)</label>
        <input type="number" id="weight" name="weight" step="0.1" required
               class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all" />
      </div>

      <button type="submit" id="calculate-btn" class="w-full py-3 px-4 bg-blue-600 text-white font-bold rounded-xl shadow-lg transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-xl" aria-label="Calculate gastric volume">
        Calculate
      </button>
    </form>

    <!-- Error Message -->
    <div id="error-message" class="hidden mt-4 p-3 bg-red-100 text-red-700 border border-red-300 rounded-md text-sm"></div>

    <!-- Results -->
    <div id="results" class="hidden mt-6 p-4 bg-gray-100 rounded-lg border border-gray-300 space-y-2" aria-live="polite">
      <h2 class="text-xl font-bold text-gray-800">Results</h2>
      <div id="csa-result" class="text-lg"></div>
      <div id="volume-result" class="text-lg"></div>
      <div id="risk-result" class="text-lg"></div>

      <div class="mt-4 pt-4 border-t border-gray-300 text-xs text-gray-600">
        <p class="text-gray-700 font-semibold mb-1">Formulas Used:</p>
        <p><strong>1. Cross-Sectional Area (CSA):</strong></p>
        <p class="pl-4">$\text{CSA} = (\text{AP} \times \text{CC} \times \pi) / 4$</p>
        <p><strong>2a. Gastric Volume (GV) for patients &ge; 14 years (Perlas's Formula):</strong></p>
        <p class="pl-4">$\text{GV (mL)} = 27 + (14.6 \times \text{CSA}) - (1.28 \times \text{Age}_{\text{years}})$</p>
        <p><strong>2b. Gastric Volume (GV) Pediatric formula for patients &lt; 14 years:</strong></p>
        <p class="pl-4">$\text{GV (mL)} = -7.8 + (3.5 \times \text{CSA}) + (0.127 \times \text{Age}_{\text{months}})$</p>
      </div>
    </div>

    <!-- Disclaimer -->
    <p class="text-gray-400 text-sm text-center mt-6">
      Developed by Dr. Heleno Paiva. For feedback, bug reports, or suggestions, please contact me at <a href="mailto:heleno@gmail.com">heleno@gmail.com</a>.
    </p>
  </div>

  <script>
    const form = document.getElementById('gastric-form');
    const resultsContainer = document.getElementById('results');
    const csaResult = document.getElementById('csa-result');
    const volumeResult = document.getElementById('volume-result');
    const riskResult = document.getElementById('risk-result');
    const errorMessageDiv = document.getElementById('error-message');

    form.addEventListener('submit', (e) => {
      e.preventDefault();

      // Grab input values
      const ap = parseFloat(document.getElementById('ap-diameter').value);
      const cc = parseFloat(document.getElementById('cc-diameter').value);
      const age = parseFloat(document.getElementById('age').value);
      const weight = parseFloat(document.getElementById('weight').value);

      // Reset previous states
      resultsContainer.classList.add('hidden');
      errorMessageDiv.classList.add('hidden');

      if (isNaN(ap) || isNaN(cc) || isNaN(age) || isNaN(weight) || ap <= 0 || cc <= 0 || age < 0 || weight <= 0) {
        errorMessageDiv.textContent = "Please enter valid positive numbers for all fields.";
        errorMessageDiv.classList.remove('hidden');
        return;
      }

      // Calculate CSA
      const csa = (ap * cc * Math.PI) / 4;

      let volume, formulaNote;

      if (age < 14) {
        const ageMonths = age * 12;
        volume = -7.8 + (3.5 * csa) + (0.127 * ageMonths);
        formulaNote = "Pediatric formula used (age < 14 years).";
      } else {
        volume = 27 + (14.6 * csa) - (1.28 * age);
        formulaNote = "Perlas formula used (age ≥ 14 years).";
      }

      const riskThreshold = 1.5 * weight;

      let riskText = '';
      let riskClass = '';

      if (volume > riskThreshold) {
        riskText = 'High Risk ⚠️';
        riskClass = 'font-bold text-red-600';
      } else {
        riskText = 'Low Risk ✅';
        riskClass = 'font-bold text-green-600';
      }

      // Display results
      csaResult.innerHTML = `<strong>Cross-Sectional Area (CSA):</strong> ${csa.toFixed(2)} cm²`;
      volumeResult.innerHTML = `<strong>Estimated Gastric Volume:</strong> ${volume.toFixed(2)} mL`;
      riskResult.innerHTML = `<strong>Aspiration Risk:</strong> <span class="${riskClass}">${riskText}</span>`;

      resultsContainer.classList.remove('hidden');

      // Rerender MathJax formulas
      if (window.MathJax) {
        MathJax.typesetPromise();
      }
    });
  </script>
</body>
</html>
